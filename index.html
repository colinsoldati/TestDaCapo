<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DaCapo. - Suivi de Pratique Musicale</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
      /* Tailwind configuration */
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['DM Sans', 'sans-serif'],
              montserrat: ['Montserrat', 'sans-serif'],
            },
            colors: {
              'brand-black': '#000000',
              'brand-white': '#FFFFFF',
              'brand-gray': '#F3F4F6', // Light gray for backgrounds
              'brand-gray-border': '#E5E7EB', // Lighter border color
              'brand-red': '#DC2626', // Red for delete actions
            }
          }
        }
      }
      /* Core Layout */
      html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
      body { display: flex; flex-direction: column; background-color: theme('colors.brand-white'); }
      header { flex-shrink: 0; background-color: theme('colors.brand-white'); z-index: 10; height: 4.5rem; }
      main { flex-grow: 1; overflow-y: auto; padding-bottom: 5rem; /* Space for sticky nav */ }
      nav { flex-shrink: 0; position: sticky; bottom: 0; background-color: theme('colors.brand-white'); z-index: 10; height: 4.5rem; }

       /* Nav button styles */
       .nav-btn span {
           font-size: 0.8rem; /* Slightly larger text */
           font-weight: 600; /* Semibold */
       }
       .nav-btn[aria-current="page"] { color: theme('colors.brand-black'); }
       .nav-btn:not([aria-current="page"]) { color: theme('colors.gray.500'); font-weight: 500; /* Normal weight for inactive */ }
       .nav-btn:not([aria-current="page"]):hover { color: theme('colors.gray.900'); }

       /* Button base styles */
       .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500;
            font-size: 0.875rem; line-height: 1.25rem;
            transition: all 0.15s ease-in-out;
            cursor: pointer; border: 1px solid transparent;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
       }
       /* Primary Button Style (Black Background, White Text) - Default for most actions */
       .btn-primary {
            background-color: theme('colors.brand-black'); color: theme('colors.brand-white'); border-color: theme('colors.brand-black');
       }
       .btn-primary:hover {
            background-color: theme('colors.gray.800'); border-color: theme('colors.gray.800');
       }
       /* Secondary Button Style (White Background, Black Text, Gray Border) */
       .btn-secondary {
            background-color: theme('colors.brand-white'); color: theme('colors.brand-black'); border-color: theme('colors.brand-gray-border');
       }
       .btn-secondary:hover {
            background-color: theme('colors.brand-gray');
       }
       /* Danger Outline Button (for Deletion) */
       .btn-danger-outline {
            background-color: theme('colors.brand-white'); color: theme('colors.brand-red'); border-color: theme('colors.red.300');
            padding: 0.3rem 0.6rem; font-size: 0.75rem;
       }
       .btn-danger-outline:hover {
            background-color: theme('colors.red.50'); border-color: theme('colors.brand-red');
       }

       /* Input styling */
       input[type="text"], input[type="date"], input[type="number"], select, textarea {
            border-radius: 0.375rem; border-color: theme('colors.brand-gray-border');
            padding: 0.5rem 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
       }
       input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: theme('colors.brand-black'); box-shadow: 0 0 0 1px theme('colors.brand-black'); outline: none;
       }
       select {
           appearance: none;
           background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
           background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
           padding-right: 2.5rem;
       }

       /* Modal Styles */
       .modal {
           position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
           display: flex; align-items: center; justify-content: center;
           z-index: 40; padding: 1rem; opacity: 0; visibility: hidden;
           transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
       }
       .modal.active { opacity: 1; visibility: visible; }
       .modal-content {
           background-color: theme('colors.brand-white'); /* Explicit white background */
           padding: 1.5rem; border-radius: 0.75rem;
           box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
           max-width: 95%; width: 500px; position: relative; max-height: 90vh;
           display: flex; flex-direction: column;
       }
        .modal-body { overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1rem; }
       .modal-footer {
            flex-shrink: 0; display: flex; justify-content: flex-end; gap: 0.5rem;
            padding-top: 1rem; border-top: 1px solid theme('colors.brand-gray-border');
       }
       .modal-close-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none;
            font-size: 1.5rem; line-height: 1; color: theme('colors.gray.400'); cursor: pointer;
       }
       .modal-close-btn:hover { color: theme('colors.gray.600'); }

       /* Message Box */
       #message-box {
           position: fixed; bottom: 5rem; right: 1rem;
           background-color: theme('colors.brand-black'); color: theme('colors.brand-white');
           padding: 1rem; border-radius: 0.5rem;
           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
           opacity: 0; visibility: hidden;
           transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
           z-index: 50; max-width: calc(100% - 2rem);
       }
        #message-box.active { opacity: 1; visibility: visible; }
       #message-box .close-message-btn {
            position: absolute; top: 0.25rem; right: 0.5rem; background: none; border: none;
            color: theme('colors.gray.300'); font-size: 1.25rem; cursor: pointer;
       }
       #message-box .close-message-btn:hover { color: theme('colors.brand-white'); }

    </style>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <link rel="icon" href="https://placehold.co/32x32/000000/FFFFFF?text=DC." type="image/png"> <link rel="apple-touch-icon" href="https://placehold.co/180x180/000000/FFFFFF?text=DaCapo."> </head>
<body class="bg-brand-white text-brand-black font-sans">

    <header class="border-b border-brand-gray-border p-4 flex items-center justify-center w-full">
        <h1 class="text-2xl font-montserrat font-bold text-center">DaCapo.</h1>
    </header>

    <main class="container mx-auto p-4 w-full">

        <section id="planification" class="space-y-6">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-montserrat font-semibold">Planification</h2>
                 <button type="button" id="add-plan-modal-trigger" class="btn btn-primary">Nouvelle session</button>
            </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-3 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Plans sauvegardés</h3>
                <div id="saved-plans-list" class="space-y-3">
                    <p class="text-sm text-gray-500 italic">Aucun plan sauvegardé.</p>
                </div>
            </div>
        </section>

        <section id="journal" class="hidden space-y-6">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-montserrat font-semibold">Journal de bord</h2>
                 <button type="button" id="add-journal-modal-trigger" class="btn btn-primary">Nouvelle entrée</button>
            </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Entrées précédentes</h3>
                <div id="journal-entries" class="space-y-4">
                    <p class="text-sm text-gray-500 italic">Aucune entrée.</p>
                </div>
            </div>
        </section>

        <section id="bibliotheque" class="hidden space-y-6">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-montserrat font-semibold">Mon répertoire</h2>
                 <button type="button" id="add-piece-modal-trigger" class="btn btn-primary">Ajouter une pièce</button>
            </div>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Pièces enregistrées</h3>
                <div id="pieces-list" class="space-y-4">
                    <p class="text-sm text-gray-500 italic">Aucune pièce enregistrée.</p>
                </div>
            </div>
        </section>

    </main>

     <nav class="border-t border-brand-gray-border p-2 w-full">
        <ul class="grid grid-cols-3 gap-2 w-full max-w-md mx-auto">
            <li class="flex justify-center">
                <button type="button" data-target="planification" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full" aria-current="page">
                    <span class="mt-1">Planification</span>
                </button>
            </li>
            <li class="flex justify-center">
                <button type="button" data-target="journal" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full">
                    <span class="mt-1">Journal</span>
                </button>
            </li>
            <li class="flex justify-center">
                <button type="button" data-target="bibliotheque" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full">
                   <span class="mt-1">Répertoire</span>
                </button>
            </li>
        </ul>
    </nav>

    <div>
        <div id="add-plan-modal" class="modal">
            <div class="modal-content bg-white">
                <button type="button" class="modal-close-btn" aria-label="Fermer">&times;</button>
                <h3 class="font-montserrat font-medium text-lg mb-4">Planifier une session</h3>
                <div class="modal-body space-y-4">
                    <div>
                        <label for="modal-session-date" class="block text-sm font-medium mb-1 text-gray-700">Date :</label>
                        <input type="date" id="modal-session-date" name="modal-session-date" class="w-full bg-brand-white">
                    </div>
                    <div>
                        <label for="modal-session-goal" class="block text-sm font-medium mb-1 text-gray-700">Objectif principal :</label>
                        <input type="text" id="modal-session-goal" name="modal-session-goal" placeholder="Ex: Fluidité arpèges Chopin Op.10 No.1" class="w-full bg-brand-white">
                    </div>
                    <fieldset class="space-y-3 border-t border-brand-gray-border pt-4">
                        <legend class="block text-sm font-medium mb-2 text-gray-700">Pièces à travailler :</legend>
                        <div id="modal-pieces-plan-list-container" class="max-h-60 overflow-y-auto pr-2 space-y-3">
                             </div>
                        <button type="button" id="modal-add-piece-plan-btn" class="btn btn-secondary w-full">
                            Ajouter une pièce
                        </button>
                    </fieldset>
                </div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-secondary modal-cancel-btn">Annuler</button>
                     <button type="button" id="modal-save-plan-btn" class="btn btn-primary">Enregistrer plan</button>
                </div>
            </div>
        </div>

        <div id="add-journal-modal" class="modal">
             <div class="modal-content bg-white">
                <button type="button" class="modal-close-btn" aria-label="Fermer">&times;</button>
                <h3 class="font-montserrat font-medium text-lg mb-4">Nouvelle entrée au journal</h3>
                 <div class="modal-body space-y-4">
                     <div>
                         <label for="modal-journal-date" class="block text-sm font-medium mb-1 text-gray-700">Date :</label>
                         <input type="date" id="modal-journal-date" name="modal-journal-date" class="w-full bg-brand-white">
                     </div>
                     <div>
                         <label for="modal-journal-piece" class="block text-sm font-medium mb-1 text-gray-700">Pièce travaillée (optionnel) :</label>
                         <select id="modal-journal-piece" name="modal-journal-piece" class="w-full bg-brand-white">
                             <option value="">-- Sélectionner une pièce --</option>
                             </select>
                     </div>
                     <div>
                         <label for="modal-journal-content" class="block text-sm font-medium mb-1 text-gray-700">Notes de pratique :</label>
                         <textarea id="modal-journal-content" name="modal-journal-content" rows="5" placeholder="Difficultés, solutions, sensations..." class="w-full bg-brand-white"></textarea>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-secondary modal-cancel-btn">Annuler</button>
                     <button type="button" id="modal-save-journal-btn" class="btn btn-primary">Enregistrer entrée</button>
                 </div>
            </div>
        </div>

        <div id="add-piece-modal" class="modal">
             <div class="modal-content bg-white">
                 <button type="button" class="modal-close-btn" aria-label="Fermer">&times;</button>
                 <h3 class="font-montserrat font-medium text-lg mb-4">Ajouter une pièce au répertoire</h3>
                 <div class="modal-body space-y-4">
                     <div>
                         <label for="modal-piece-title" class="block text-sm font-medium mb-1 text-gray-700">Titre :</label>
                         <input type="text" id="modal-piece-title" name="modal-piece-title" placeholder="Ex: Sonate 'Pathétique', Op. 13" class="w-full bg-brand-white">
                     </div>
                     <div>
                         <label for="modal-piece-composer" class="block text-sm font-medium mb-1 text-gray-700">Compositeur :</label>
                         <input type="text" id="modal-piece-composer" name="modal-piece-composer" placeholder="Ex: Ludwig van Beethoven" class="w-full bg-brand-white">
                     </div>
                     <div>
                         <label for="modal-piece-category" class="block text-sm font-medium mb-1 text-gray-700">Catégorie :</label>
                         <select id="modal-piece-category" name="modal-piece-category" class="w-full bg-brand-white">
                              </select>
                     </div>
                 </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-secondary modal-cancel-btn">Annuler</button>
                     <button type="button" id="modal-add-piece-btn" class="btn btn-primary">Ajouter pièce</button>
                 </div>
            </div>
        </div>
    </div>

    <div id="message-box">
        <div class="flex justify-between items-center">
             <span id="message-text" class="text-sm mr-4"></span>
             <button type="button" class="close-message-btn" aria-label="Fermer message">&times;</button>
        </div>
    </div>

    <script>
        // --- Constants ---
        const PIECES_STORAGE_KEY = 'dacapoPieces';
        const JOURNAL_STORAGE_KEY = 'dacapoJournalEntries';
        const PLANS_STORAGE_KEY = 'dacapoPlans';
        const PIECE_CATEGORIES = ["Sonate", "Concerto", "Caprice/Etude", "Prélude", "Fugue", "Nocturne", "Valse", "Impromptu", "Pièce solo", "Musique de chambre", "Autre"];

        // --- DOM Elements ---
        const mainElement = document.querySelector('main');
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('main section');
        const addPlanModal = document.getElementById('add-plan-modal');
        const addJournalModal = document.getElementById('add-journal-modal');
        const addPieceModal = document.getElementById('add-piece-modal');
        const addPlanTrigger = document.getElementById('add-plan-modal-trigger');
        const addJournalTrigger = document.getElementById('add-journal-modal-trigger');
        const addPieceTrigger = document.getElementById('add-piece-modal-trigger');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // --- Utility Functions ---
        function showMessage(text, duration = 3000) { /* ... (no change) ... */
            if (!messageBox || !messageText) return; messageText.textContent = text; messageBox.classList.add('active'); let timerId = messageBox.dataset.timerId; if (timerId) clearTimeout(timerId); timerId = setTimeout(() => { messageBox.classList.remove('active'); messageBox.dataset.timerId = ''; }, duration); messageBox.dataset.timerId = timerId;
        }
        function hideMessage() { /* ... (no change) ... */
             if (!messageBox) return; let timerId = messageBox.dataset.timerId; if (timerId) clearTimeout(timerId); messageBox.classList.remove('active'); messageBox.dataset.timerId = '';
        }
        function getStoredData(key) { /* ... (no change) ... */
            try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { console.error(`Error parsing localStorage key "${key}":`, e); return []; }
        }
        function saveStoredData(key, data) { /* ... (no change) ... */
             try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`Error saving to localStorage key "${key}":`, e); showMessage("Erreur sauvegarde. Stockage plein?", 5000); }
        }
        function formatDate(dateString) { /* ... (no change) ... */
             if (!dateString) return 'Date inconnue'; const [year, month, day] = dateString.split('-'); if (!year || !month || !day || isNaN(parseInt(year)) || isNaN(parseInt(month)) || isNaN(parseInt(day))) return 'Date invalide'; try { const date = new Date(Date.UTC(year, month - 1, day)); return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }); } catch (e) { return 'Date invalide'; }
        }

        // --- Reusable Dropdown Populator ---
        function populatePieceDropdown(selectElement, includeDefault = true) {
            if (!selectElement) return;
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            const currentValue = selectElement.value; // Preserve selection if possible
            const defaultOptionText = selectElement.options[0]?.textContent || '-- Sélectionner une pièce --';

            selectElement.innerHTML = includeDefault ? `<option value="">${defaultOptionText}</option>` : '';

            pieces.sort((a, b) => (a.title || '').localeCompare(b.title || '')).forEach(piece => {
                const option = document.createElement('option');
                option.value = piece.id;
                option.textContent = `${piece.title}${piece.composer ? ` (${piece.composer})` : ''}`;
                selectElement.appendChild(option);
            });

            // Restore previous selection if it exists
            if (currentValue && pieces.some(p => String(p.id) === currentValue)) {
                selectElement.value = currentValue;
            } else if (includeDefault) {
                selectElement.value = ""; // Ensure default is selected if previous selection is gone
            }
        }


        // --- Modal Handling ---
        function openModal(modalElement) { /* ... (no change) ... */
            if (!modalElement) return; const form = modalElement.querySelector('form'); if (form) form.reset(); if (modalElement.id === 'add-plan-modal') resetPlanModalForm(); if (modalElement.id === 'add-journal-modal') resetJournalModalForm(); if (modalElement.id === 'add-piece-modal') resetPieceModalForm(); modalElement.classList.add('active'); const focusable = modalElement.querySelector('input, select, textarea, button:not([aria-label="Fermer"])'); if (focusable) focusable.focus();
        }
        function closeModal(modalElement) { /* ... (no change) ... */
            if (!modalElement) return; modalElement.classList.remove('active');
        }
        // Setup Modal Triggers & Close Buttons
        addPlanTrigger?.addEventListener('click', () => openModal(addPlanModal));
        addJournalTrigger?.addEventListener('click', () => openModal(addJournalModal));
        addPieceTrigger?.addEventListener('click', () => openModal(addPieceModal));
        document.querySelectorAll('.modal').forEach(modal => { /* ... (no change) ... */
            modal.querySelector('.modal-close-btn')?.addEventListener('click', () => closeModal(modal)); modal.querySelector('.modal-cancel-btn')?.addEventListener('click', () => closeModal(modal)); modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(modal); });
        });
        messageBox?.querySelector('.close-message-btn')?.addEventListener('click', hideMessage);

        // --- Navigation ---
        function setActiveSection(targetId) { /* ... (no change) ... */
            sections.forEach(section => section.classList.add('hidden')); const targetSection = document.getElementById(targetId); if (targetSection) targetSection.classList.remove('hidden'); navButtons.forEach(btn => btn.setAttribute('aria-current', btn.dataset.target === targetId ? 'page' : 'false')); requestAnimationFrame(() => { if (targetId === 'planification') loadSavedPlans(); else if (targetId === 'journal') { populateJournalPieceDropdown(modalJournalPieceSelect); loadJournalEntries(); } else if (targetId === 'bibliotheque') { populateCategoryDropdown(); loadPieces(); } if (mainElement) mainElement.scrollTop = 0; });
        }
        navButtons.forEach(button => button.addEventListener('click', () => setActiveSection(button.dataset.target)));

        // --- Planification Section ---
        const savedPlansListDiv = document.getElementById('saved-plans-list');
        const modalSessionDateInput = document.getElementById('modal-session-date');
        const modalSessionGoalInput = document.getElementById('modal-session-goal');
        const modalPiecesPlanListContainer = document.getElementById('modal-pieces-plan-list-container'); // Renamed ID
        const modalAddPiecePlanBtn = document.getElementById('modal-add-piece-plan-btn'); // Renamed ID
        const modalSavePlanBtn = document.getElementById('modal-save-plan-btn');

        // Creates a row for selecting a piece and setting its duration in the plan modal
        function createPiecePlanElement(planItem = { pieceId: '', duration: '' }) {
             const itemDiv = document.createElement('div');
            itemDiv.className = 'piece-plan-item flex items-center space-x-2 p-2 bg-white rounded-md border border-brand-gray-border';
            // Select dropdown for piece
            const selectElement = document.createElement('select');
            selectElement.className = 'plan-piece-select flex-grow border-gray-300 rounded-md focus:ring-brand-black focus:border-brand-black p-1 text-sm bg-white'; // Added bg-white
            populatePieceDropdown(selectElement, true); // Populate with pieces
            selectElement.value = planItem.pieceId || ''; // Set initial value if provided

            // Duration input
            const durationInput = document.createElement('input');
            durationInput.type = 'number';
            durationInput.placeholder = 'Durée';
            durationInput.min = '1';
            durationInput.value = planItem.duration || '';
            durationInput.className = 'plan-piece-duration w-16 border-gray-300 rounded-md focus:ring-brand-black focus:border-brand-black p-1 text-sm';

            // Duration label
            const durationLabel = document.createElement('span');
            durationLabel.className = 'text-xs text-gray-500';
            durationLabel.textContent = 'min';

            // Delete button
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'remove-piece-plan-btn btn btn-danger-outline !p-1 !text-xs';
            deleteButton.title = 'Supprimer cette pièce du plan';
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', (e) => e.currentTarget.closest('.piece-plan-item').remove());

            itemDiv.appendChild(selectElement);
            itemDiv.appendChild(durationInput);
            itemDiv.appendChild(durationLabel);
            itemDiv.appendChild(deleteButton);
            return itemDiv;
        }

        function resetPlanModalForm() {
            if (!addPlanModal) return;
            modalSessionDateInput.value = new Date().toISOString().split('T')[0];
            modalSessionGoalInput.value = '';
            if (modalPiecesPlanListContainer) {
                modalPiecesPlanListContainer.innerHTML = ''; // Clear pieces
                modalPiecesPlanListContainer.appendChild(createPiecePlanElement()); // Add one empty
            }
        }

        modalAddPiecePlanBtn?.addEventListener('click', () => {
            modalPiecesPlanListContainer?.appendChild(createPiecePlanElement());
        });

        function savePlan() {
            const date = modalSessionDateInput.value;
            const goal = modalSessionGoalInput.value.trim();
            const piecesPlan = []; // Changed variable name
            modalPiecesPlanListContainer?.querySelectorAll('.piece-plan-item').forEach(item => {
                const pieceSelect = item.querySelector('.plan-piece-select');
                const durationInput = item.querySelector('.plan-piece-duration');
                const pieceId = pieceSelect ? parseInt(pieceSelect.value, 10) : null; // Get piece ID
                const duration = durationInput ? parseInt(durationInput.value, 10) : null;
                if (pieceId) { // Only add if a piece is selected
                    piecesPlan.push({ pieceId, duration: duration > 0 ? duration : null });
                }
            });

            if (!date) { showMessage("Veuillez sélectionner une date.", 3000); return; }
            if (!goal && piecesPlan.length === 0) { showMessage("Ajouter un objectif ou une pièce.", 3000); return; }

            const plans = getStoredData(PLANS_STORAGE_KEY);
            // Changed 'exercises' to 'pieces' in the saved object
            const newPlan = { id: Date.now(), date, goal, pieces: piecesPlan };
            plans.push(newPlan);
            saveStoredData(PLANS_STORAGE_KEY, plans);

            showMessage("Plan enregistré !", 2000);
            loadSavedPlans();
            closeModal(addPlanModal);
        }

        modalSavePlanBtn?.addEventListener('click', savePlan);

        function loadSavedPlans() {
            const plans = getStoredData(PLANS_STORAGE_KEY);
            const allPieces = getStoredData(PIECES_STORAGE_KEY); // Get all pieces for name lookup
            savedPlansListDiv.innerHTML = '';

            if (plans.length === 0) {
                savedPlansListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun plan sauvegardé.</p>';
                return;
            }
            plans.sort((a, b) => new Date(b.date) - new Date(a.date));
            plans.forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = 'p-3 bg-white rounded-md border border-brand-gray-border flex justify-between items-start gap-2';

                // Generate list of pieces for the plan
                const piecesHtmlList = (plan.pieces || []) // Use 'pieces' key now
                    .map(planItem => {
                        const piece = allPieces.find(p => p.id === planItem.pieceId);
                        const pieceName = piece ? `${piece.title}${piece.composer ? ` (${piece.composer})` : ''}` : 'Pièce inconnue';
                        return `<li>${pieceName}${planItem.duration ? ` (${planItem.duration} min)` : ''}</li>`;
                    })
                    .join('');

                planDiv.innerHTML = `
                    <div class="flex-grow text-sm">
                        <p class="font-medium">${formatDate(plan.date)}</p>
                        ${plan.goal ? `<p class="text-xs text-gray-700 mt-1"><em>Objectif:</em> ${plan.goal}</p>` : ''}
                        ${piecesHtmlList ? `<ul class="text-xs text-gray-700 mt-1 list-disc list-inside pl-1">${piecesHtmlList}</ul>` : ''}
                    </div>
                    <button type="button" data-id="${plan.id}" class="remove-plan-btn btn btn-danger-outline !p-1 !text-xs flex-shrink-0" title="Supprimer">Supprimer</button>
                `;
                planDiv.querySelector('.remove-plan-btn').addEventListener('click', removePlan);
                savedPlansListDiv.appendChild(planDiv);
            });
        }

        function removePlan(event) { /* ... (no change) ... */
             const planIdToRemove = parseInt(event.currentTarget.dataset.id, 10); let plans = getStoredData(PLANS_STORAGE_KEY); plans = plans.filter(plan => plan.id !== planIdToRemove); saveStoredData(PLANS_STORAGE_KEY, plans); loadSavedPlans(); showMessage("Plan supprimé.", 2000);
        }

        // --- Bibliothèque Section (Répertoire) ---
        const piecesListDiv = document.getElementById('pieces-list');
        const modalPieceTitleInput = document.getElementById('modal-piece-title');
        const modalPieceComposerInput = document.getElementById('modal-piece-composer');
        const modalPieceCategorySelect = document.getElementById('modal-piece-category');
        const modalAddPieceBtn = document.getElementById('modal-add-piece-btn');

        function populateCategoryDropdown() { /* ... (no change) ... */
             if (!modalPieceCategorySelect || modalPieceCategorySelect.options.length > 1) return; modalPieceCategorySelect.innerHTML = '<option value="" disabled selected>Choisir une catégorie...</option>'; PIECE_CATEGORIES.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; modalPieceCategorySelect.appendChild(option); }); modalPieceCategorySelect.value = "";
        }
        function resetPieceModalForm() { /* ... (no change) ... */
            if (!addPieceModal) return; modalPieceTitleInput.value = ''; modalPieceComposerInput.value = ''; modalPieceCategorySelect.value = '';
        }
        function loadPieces() { /* ... (no change) ... */
            const pieces = getStoredData(PIECES_STORAGE_KEY); piecesListDiv.innerHTML = ''; if (pieces.length === 0) { piecesListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune pièce enregistrée.</p>'; return; } const groupedPieces = pieces.reduce((acc, piece) => { const cat = piece.category || "Autre"; (acc[cat] = acc[cat] || []).push(piece); return acc; }, {}); const sortedCategories = Object.keys(groupedPieces).sort((a, b) => { if (a === "Autre") return 1; if (b === "Autre") return -1; return a.localeCompare(b); }); sortedCategories.forEach(category => { const categoryDiv = document.createElement('div'); categoryDiv.className = 'mb-4'; const categoryTitle = document.createElement('h4'); categoryTitle.className = 'font-medium text-sm uppercase tracking-wider text-gray-500 mb-2 border-b border-brand-gray-border pb-1'; categoryTitle.textContent = category; categoryDiv.appendChild(categoryTitle); const categoryList = document.createElement('div'); categoryList.className = 'space-y-3'; groupedPieces[category].sort((a, b) => { const comp = (a.composer || '').localeCompare(b.composer || ''); return comp !== 0 ? comp : (a.title || '').localeCompare(b.title || ''); }).forEach(piece => { const pieceDiv = document.createElement('div'); pieceDiv.className = 'p-3 bg-white rounded-md border border-brand-gray-border flex justify-between items-start gap-2'; pieceDiv.innerHTML = ` <div class="flex-grow text-sm"> <p class="font-medium">${piece.title || '?'}</p> <p class="text-xs text-gray-600 mt-1">${piece.composer || '?'}</p> </div> <button type="button" data-id="${piece.id}" class="remove-piece-btn btn btn-danger-outline !p-1 !text-xs flex-shrink-0" title="Supprimer">Supprimer</button> `; pieceDiv.querySelector('.remove-piece-btn').addEventListener('click', removePiece); categoryList.appendChild(pieceDiv); }); categoryDiv.appendChild(categoryList); piecesListDiv.appendChild(categoryDiv); });
        }
        function addPiece() { /* ... (no change) ... */
            const title = modalPieceTitleInput.value.trim(); const composer = modalPieceComposerInput.value.trim(); const category = modalPieceCategorySelect.value; if (!title) { showMessage("Veuillez entrer un titre.", 3000); return; } if (!category) { showMessage("Veuillez choisir une catégorie.", 3000); return; } const pieces = getStoredData(PIECES_STORAGE_KEY); const newPiece = { id: Date.now(), title, composer, category }; pieces.push(newPiece); saveStoredData(PIECES_STORAGE_KEY, pieces); showMessage("Pièce ajoutée !", 2000); loadPieces(); populateJournalPieceDropdown(modalJournalPieceSelect); closeModal(addPieceModal);
        }
        modalAddPieceBtn?.addEventListener('click', addPiece);
        function removePiece(event) { /* ... (no change) ... */
            const pieceIdToRemove = parseInt(event.currentTarget.dataset.id, 10); let pieces = getStoredData(PIECES_STORAGE_KEY); pieces = pieces.filter(piece => piece.id !== pieceIdToRemove); saveStoredData(PIECES_STORAGE_KEY, pieces); loadPieces(); showMessage("Pièce supprimée.", 2000); populateJournalPieceDropdown(modalJournalPieceSelect);
        }

        // --- Journal Section ---
        const journalEntriesDiv = document.getElementById('journal-entries');
        const modalJournalDateInput = document.getElementById('modal-journal-date');
        const modalJournalContentInput = document.getElementById('modal-journal-content');
        const modalJournalPieceSelect = document.getElementById('modal-journal-piece');
        const modalSaveJournalBtn = document.getElementById('modal-save-journal-btn');

        // Uses the reusable function populatePieceDropdown
        function resetJournalModalForm() { /* ... (no change) ... */
             if (!addJournalModal) return; modalJournalDateInput.value = new Date().toISOString().split('T')[0]; modalJournalContentInput.value = ''; modalJournalPieceSelect.value = '';
        }
        function loadJournalEntries() { /* ... (no change) ... */
            const entries = getStoredData(JOURNAL_STORAGE_KEY); const pieces = getStoredData(PIECES_STORAGE_KEY); journalEntriesDiv.innerHTML = ''; if (entries.length === 0) { journalEntriesDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune entrée.</p>'; return; } entries.sort((a, b) => new Date(b.date) - new Date(a.date)); entries.forEach(entry => { const entryDiv = document.createElement('div'); entryDiv.className = 'p-4 bg-white rounded-md border border-brand-gray-border relative'; const piece = entry.pieceId ? pieces.find(p => p.id === entry.pieceId) : null; entryDiv.innerHTML = ` <button type="button" data-id="${entry.id}" class="remove-journal-btn btn btn-danger-outline !p-1 !text-xs absolute top-2 right-2" title="Supprimer">Supprimer</button> <div class="flex justify-between items-center mb-2 pr-20"> <p class="font-medium text-sm">${formatDate(entry.date)}</p> ${piece ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full flex-shrink-0">${piece.category || 'Autre'}</span>` : ''} </div> ${piece ? `<div class="mb-2 text-sm"><p class="font-semibold">${piece.title || '?'}</p><p class="text-xs text-gray-600">${piece.composer || '?'}</p></div>` : ''} <p class="text-sm whitespace-pre-wrap text-gray-800">${entry.content || 'Aucune note.'}</p> `; entryDiv.querySelector('.remove-journal-btn').addEventListener('click', removeJournalEntry); journalEntriesDiv.appendChild(entryDiv); });
        }
        function saveJournalEntry() { /* ... (no change) ... */
            const date = modalJournalDateInput.value; const content = modalJournalContentInput.value.trim(); const pieceId = modalJournalPieceSelect.value ? parseInt(modalJournalPieceSelect.value, 10) : null; if (!date) { showMessage("Veuillez sélectionner une date.", 3000); return; } if (!content) { showMessage("Veuillez ajouter des notes.", 3000); return; } const entries = getStoredData(JOURNAL_STORAGE_KEY); const newEntry = { id: Date.now(), date, content, pieceId }; entries.push(newEntry); saveStoredData(JOURNAL_STORAGE_KEY, entries); showMessage("Entrée enregistrée !", 2000); loadJournalEntries(); closeModal(addJournalModal);
        }
        modalSaveJournalBtn?.addEventListener('click', saveJournalEntry);
         function removeJournalEntry(event) { /* ... (no change) ... */
             const entryIdToRemove = parseInt(event.currentTarget.dataset.id, 10); let entries = getStoredData(JOURNAL_STORAGE_KEY); entries = entries.filter(entry => entry.id !== entryIdToRemove); saveStoredData(JOURNAL_STORAGE_KEY, entries); loadJournalEntries(); showMessage("Entrée supprimée.", 2000);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const today = new Date().toISOString().split('T')[0];
                modalSessionDateInput.value = today;
                modalJournalDateInput.value = today;
            } catch (e) { console.error("Error setting initial date:", e); }

             // Populate static dropdowns in modals
             populateCategoryDropdown(); // For piece modal
             populatePieceDropdown(modalJournalPieceSelect); // For journal modal

             setActiveSection('planification'); // Set initial section
             loadSavedPlans(); // Load data for initial section

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js', { scope: './' })
                    .then(reg => console.log('Service Worker: Registered scope:', reg.scope))
                    .catch(err => console.error('Service Worker: Registration failed:', err));
            } else { console.log('Service workers not supported.'); }
        });

    </script>
</body>
</html>
