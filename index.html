<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaCapo - Suivi de Pratique Musicale</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
      /* Tailwind configuration */
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['DM Sans', 'sans-serif'],
              montserrat: ['Montserrat', 'sans-serif'],
            },
            colors: {
              'brand-black': '#000000',
              'brand-white': '#FFFFFF',
              'brand-gray': '#F3F4F6', // Light gray for backgrounds
              'brand-gray-border': '#E5E7EB', // Lighter border color
              'brand-red': '#DC2626', // Red for delete actions
            }
          }
        }
      }
      /* Core Layout: Flex column taking full viewport height */
      html, body {
          height: 100%;
          margin: 0;
          padding: 0;
          overflow: hidden; /* Prevent scrolling on body itself */
      }
      body {
          display: flex;
          flex-direction: column;
          background-color: theme('colors.brand-white');
      }
      /* Header: Normal flow, doesn't shrink */
      header {
          flex-shrink: 0;
          background-color: theme('colors.brand-white');
          z-index: 10; /* Keep above main content if needed */
      }
      /* Main Content: Takes remaining space and scrolls */
      main {
          flex-grow: 1;
          overflow-y: auto;
          /* Padding bottom to prevent content hiding under sticky nav */
          /* Value should match nav height + desired space */
          padding-bottom: 5rem; /* Adjust if nav height changes */
      }
      /* Navigation: Sticky at the bottom, doesn't shrink */
      nav {
          flex-shrink: 0;
          position: sticky;
          bottom: 0;
          background-color: theme('colors.brand-white'); /* Essential for sticky */
          z-index: 10; /* Keep above main content */
      }

       /* Style for active nav button */
       .nav-btn[aria-current="page"] {
           color: theme('colors.brand-black');
           font-weight: 600;
       }
       .nav-btn:not([aria-current="page"]) {
            color: theme('colors.gray.500');
       }
       .nav-btn:not([aria-current="page"]):hover {
            color: theme('colors.gray.900');
       }
       /* Custom button base styles */
       .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500;
            font-size: 0.875rem; line-height: 1.25rem;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
            cursor: pointer; border: 1px solid transparent;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
       }
       .btn-primary {
            background-color: theme('colors.brand-black'); color: theme('colors.brand-white'); border-color: theme('colors.brand-black');
       }
       .btn-primary:hover {
            background-color: theme('colors.gray.800'); border-color: theme('colors.gray.800');
       }
       .btn-secondary {
            background-color: theme('colors.brand-white'); color: theme('colors.brand-black'); border-color: theme('colors.brand-gray-border');
       }
       .btn-secondary:hover {
            background-color: theme('colors.brand-gray');
       }
       .btn-danger { /* Not used currently, but defined */
            background-color: theme('colors.brand-red'); color: theme('colors.brand-white'); border-color: theme('colors.brand-red');
            padding: 0.3rem 0.6rem; font-size: 0.75rem;
       }
       .btn-danger:hover {
            background-color: theme('colors.red.700'); border-color: theme('colors.red.700');
       }
       .btn-danger-outline {
            background-color: theme('colors.brand-white'); color: theme('colors.brand-red'); border-color: theme('colors.red.300');
            padding: 0.3rem 0.6rem; font-size: 0.75rem;
       }
       .btn-danger-outline:hover {
            background-color: theme('colors.red.50'); border-color: theme('colors.brand-red');
       }
       /* Input styling */
       input[type="text"], input[type="date"], input[type="number"], select, textarea {
            border-radius: 0.375rem; border-color: theme('colors.brand-gray-border');
            padding: 0.5rem 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
       }
       input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: theme('colors.brand-black'); box-shadow: 0 0 0 1px theme('colors.brand-black'); outline: none;
       }
       select {
           appearance: none;
           background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
           background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
           padding-right: 2.5rem;
       }
       /* Specific height for header and nav to calculate main padding */
       header { height: 4.5rem; }
       nav { height: 4.5rem; }
       /* Adjust message box position based on sticky nav height */
       #message-box { bottom: 5rem; /* nav height + 0.5rem spacing */ }

    </style>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <link rel="icon" href="https://placehold.co/32x32/000000/FFFFFF?text=DC" type="image/png">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/000000/FFFFFF?text=DC"> </head>
<body class="bg-brand-white text-brand-black font-sans">

    <header class="border-b border-brand-gray-border p-4 flex items-center justify-center w-full">
        <h1 class="text-2xl font-montserrat font-bold text-center">DaCapo</h1>
    </header>

    <main class="container mx-auto p-4 w-full">

        <section id="planification" class="space-y-6">
            <h2 class="text-xl font-montserrat font-semibold mb-4 border-b border-brand-gray-border pb-2">Planification de Session</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg">Nouvelle Session</h3>
                <div>
                    <label for="session-date" class="block text-sm font-medium mb-1 text-gray-700">Date :</label>
                    <input type="date" id="session-date" name="session-date" class="w-full bg-brand-white">
                </div>
                 <div>
                    <label for="session-goal" class="block text-sm font-medium mb-1 text-gray-700">Objectif Principal :</label>
                    <input type="text" id="session-goal" name="session-goal" placeholder="Ex: Fluidité arpèges Chopin Op.10 No.1" class="w-full bg-brand-white">
                </div>

                <fieldset class="space-y-3">
                    <legend class="block text-sm font-medium mb-1 text-gray-700">Exercices :</legend>
                    <div id="exercices-list" class="space-y-3">
                        <div class="exercice-item flex items-center space-x-2 p-2 bg-white rounded-md border border-brand-gray-border">
                             <input type="text" placeholder="Exercice (gamme, étude, mesure...)" class="exercice-text flex-grow border-none focus:ring-0 bg-transparent p-1">
                             <input type="number" placeholder="Durée" min="1" class="exercice-duration w-20 border-gray-300 rounded-md focus:ring-brand-black focus:border-brand-black p-1 text-sm">
                             <span class="text-sm text-gray-500">min</span>
                             <button type="button" class="remove-exercice-btn btn btn-danger-outline !p-1 !text-xs" title="Supprimer cet exercice">
                                 Supprimer
                             </button>
                        </div>
                         </div>
                    <button type="button" id="add-exercice-btn" class="btn btn-secondary w-full">
                        Ajouter un exercice
                    </button>
                </fieldset>

                 <button type="button" id="save-plan-btn" class="btn btn-primary w-full mt-3">
                    Enregistrer ce Plan
                </button>
            </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-3 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Plans Sauvegardés</h3>
                <div id="saved-plans-list" class="space-y-3">
                    <p class="text-sm text-gray-500 italic">Aucun plan sauvegardé pour le moment.</p>
                </div>
            </div>
        </section>

        <section id="journal" class="hidden space-y-6">
            <h2 class="text-xl font-montserrat font-semibold mb-4 border-b border-brand-gray-border pb-2">Journal de Bord</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                 <h3 class="font-montserrat font-medium text-lg">Nouvelle Entrée</h3>
                 <div>
                     <label for="journal-date" class="block text-sm font-medium mb-1 text-gray-700">Date :</label>
                     <input type="date" id="journal-date" name="journal-date" class="w-full bg-brand-white">
                 </div>
                  <div>
                     <label for="journal-piece" class="block text-sm font-medium mb-1 text-gray-700">Pièce Travaillée (Optionnel) :</label>
                     <select id="journal-piece" name="journal-piece" class="w-full bg-brand-white">
                         <option value="">-- Sélectionner une pièce du répertoire --</option>
                         </select>
                 </div>
                 <div>
                     <label for="journal-content" class="block text-sm font-medium mb-1 text-gray-700">Notes de pratique :</label>
                     <textarea id="journal-content" name="journal-content" rows="5" placeholder="Difficultés rencontrées, solutions trouvées, sensations, objectifs atteints..." class="w-full bg-brand-white"></textarea>
                 </div>
                 <button type="button" id="save-journal-btn" class="btn btn-primary w-full">
                     Enregistrer l'entrée
                 </button>
             </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Entrées Précédentes</h3>
                <div id="journal-entries" class="space-y-4">
                    <p class="text-sm text-gray-500 italic">Aucune entrée pour le moment.</p>
                </div>
            </div>
        </section>

        <section id="bibliotheque" class="hidden space-y-6">
            <h2 class="text-xl font-montserrat font-semibold mb-4 border-b border-brand-gray-border pb-2">Mon Répertoire</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                 <h3 class="font-montserrat font-medium text-lg">Ajouter une Pièce</h3>
                 <div>
                     <label for="piece-title" class="block text-sm font-medium mb-1 text-gray-700">Titre :</label>
                     <input type="text" id="piece-title" name="piece-title" placeholder="Ex: Sonate 'Pathétique', Op. 13" class="w-full bg-brand-white">
                 </div>
                 <div>
                     <label for="piece-composer" class="block text-sm font-medium mb-1 text-gray-700">Compositeur :</label>
                     <input type="text" id="piece-composer" name="piece-composer" placeholder="Ex: Ludwig van Beethoven" class="w-full bg-brand-white">
                 </div>
                  <div>
                     <label for="piece-category" class="block text-sm font-medium mb-1 text-gray-700">Genre :</label>
                     <select id="piece-category" name="piece-category" class="w-full bg-brand-white">
                         </select>
                 </div>
                 <button type="button" id="add-piece-btn" class="btn btn-primary w-full">
                     Ajouter la pièce
                 </button>
            </div>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-5 space-y-4 shadow-sm">
                <h3 class="font-montserrat font-medium text-lg mb-3">Pièces Enregistrées</h3>
                <div id="pieces-list" class="space-y-4">
                    <p class="text-sm text-gray-500 italic">Aucune pièce enregistrée pour le moment.</p>
                </div>
            </div>
        </section>

         <div id="message-box" class="fixed right-4 bg-brand-black text-brand-white p-4 rounded-lg shadow-lg hidden opacity-0 transition-opacity duration-300 z-50 max-w-xs">
            <div class="flex justify-between items-center">
                 <span id="message-text" class="text-sm"></span>
                 <button onclick="this.parentElement.parentElement.style.opacity = 0; setTimeout(() => this.parentElement.parentElement.classList.add('hidden'), 300);" class="ml-3 text-gray-300 hover:text-white">&times;</button>
            </div>
        </div>

    </main>

    <nav class="border-t border-brand-gray-border p-2 w-full">
        <ul class="grid grid-cols-3 gap-2 w-full max-w-md mx-auto"> <li class="flex justify-center">
                <button type="button" data-target="planification" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full" aria-current="page">
                    <span class="text-xs font-medium mt-1">Planification</span>
                </button>
            </li>
            <li class="flex justify-center">
                <button type="button" data-target="journal" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full">
                    <span class="text-xs font-medium mt-1">Journal</span>
                </button>
            </li>
            <li class="flex justify-center">
                <button type="button" data-target="bibliotheque" class="nav-btn flex flex-col items-center p-2 rounded-md text-center w-full">
                   <span class="text-xs font-medium mt-1">Répertoire</span>
                </button>
            </li>
        </ul>
    </nav>

    <script>
        // --- Constants ---
        const PIECES_STORAGE_KEY = 'dacapoPieces';
        const JOURNAL_STORAGE_KEY = 'dacapoJournalEntries';
        const PLANS_STORAGE_KEY = 'dacapoPlans';
        const PIECE_CATEGORIES = ["Sonate", "Concerto", "Caprice/Etude", "Prélude", "Fugue", "Nocturne", "Valse", "Impromptu", "Pièce solo", "Musique de chambre", "Autre"];

        // --- Utility Functions ---
        function showMessage(text, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (!messageBox || !messageText) return;

            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            void messageBox.offsetWidth; // Force reflow for transition
            messageBox.style.opacity = 1;

            // Auto-hide timer
            let timerId = messageBox.dataset.timerId;
            if (timerId) clearTimeout(timerId); // Clear previous timer if message shown rapidly

            timerId = setTimeout(() => {
                 messageBox.style.opacity = 0;
                 setTimeout(() => messageBox.classList.add('hidden'), 300); // Hide after transition
                 messageBox.dataset.timerId = '';
            }, duration);
            messageBox.dataset.timerId = timerId; // Store timer ID
        }

        function getStoredData(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || '[]');
            } catch (e) {
                console.error(`Error parsing localStorage key "${key}":`, e);
                return [];
            }
        }

        function saveStoredData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                 console.error(`Error saving to localStorage key "${key}":`, e);
                 showMessage("Erreur lors de la sauvegarde. Stockage plein?", 5000);
            }
        }

        function formatDate(dateString) {
             if (!dateString) return 'Date inconnue';
             const [year, month, day] = dateString.split('-');
             if (!year || !month || !day || isNaN(parseInt(year)) || isNaN(parseInt(month)) || isNaN(parseInt(day))) return 'Date invalide';
             try {
                // Use UTC date to avoid timezone issues with YYYY-MM-DD input
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
             } catch (e) {
                 return 'Date invalide';
             }
        }

        // --- Navigation ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('main section');
        const mainElement = document.querySelector('main'); // Cache main element

        function setActiveSection(targetId) {
            sections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            navButtons.forEach(btn => {
                btn.setAttribute('aria-current', btn.dataset.target === targetId ? 'page' : 'false');
            });

            // Load data for the activated section
            // Using requestAnimationFrame to ensure rendering happens after DOM update
            requestAnimationFrame(() => {
                if (targetId === 'planification') {
                    loadSavedPlans();
                } else if (targetId === 'journal') {
                    populateJournalPieceDropdown();
                    loadJournalEntries();
                } else if (targetId === 'bibliotheque') {
                    loadPieces();
                }
                // Scroll main content to top
                if (mainElement) mainElement.scrollTop = 0;
            });
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveSection(button.dataset.target);
            });
        });

        // --- Planification Section ---
        const sessionDateInput = document.getElementById('session-date');
        const sessionGoalInput = document.getElementById('session-goal');
        const addExerciceBtn = document.getElementById('add-exercice-btn');
        const exercicesListDiv = document.getElementById('exercices-list');
        const savePlanBtn = document.getElementById('save-plan-btn');
        const savedPlansListDiv = document.getElementById('saved-plans-list');

        function createExerciceElement(exercise = { text: '', duration: '' }) {
             const exerciceDiv = document.createElement('div');
            exerciceDiv.className = 'exercice-item flex items-center space-x-2 p-2 bg-white rounded-md border border-brand-gray-border';
            exerciceDiv.innerHTML = `
                <input type="text" placeholder="Exercice (gamme, étude, mesure...)" value="${exercise.text || ''}" class="exercice-text flex-grow border-none focus:ring-0 bg-transparent p-1">
                <input type="number" placeholder="Durée" min="1" value="${exercise.duration || ''}" class="exercice-duration w-20 border-gray-300 rounded-md focus:ring-brand-black focus:border-brand-black p-1 text-sm">
                <span class="text-sm text-gray-500">min</span>
                <button type="button" class="remove-exercice-btn btn btn-danger-outline !p-1 !text-xs" title="Supprimer cet exercice">
                    Supprimer
                </button>
            `;
            exerciceDiv.querySelector('.remove-exercice-btn').addEventListener('click', (e) => {
                 e.currentTarget.closest('.exercice-item').remove();
            });
            return exerciceDiv;
        }

        addExerciceBtn.addEventListener('click', () => {
            exercicesListDiv.appendChild(createExerciceElement());
        });

        function savePlan() {
            const date = sessionDateInput.value;
            const goal = sessionGoalInput.value.trim();
            const exercises = [];
            exercicesListDiv.querySelectorAll('.exercice-item').forEach(item => {
                const textInput = item.querySelector('.exercice-text');
                const durationInput = item.querySelector('.exercice-duration');
                const text = textInput ? textInput.value.trim() : '';
                const duration = durationInput ? parseInt(durationInput.value, 10) : null;
                if (text) {
                    exercises.push({ text, duration: duration > 0 ? duration : null });
                }
            });

            if (!date) {
                showMessage("Veuillez sélectionner une date.", 3000); return;
            }
            if (!goal && exercises.length === 0) {
                showMessage("Veuillez ajouter un objectif ou un exercice.", 3000); return;
            }

            const plans = getStoredData(PLANS_STORAGE_KEY);
            const newPlan = { id: Date.now(), date, goal, exercises };
            plans.push(newPlan);
            saveStoredData(PLANS_STORAGE_KEY, plans);

            sessionGoalInput.value = '';
            exercicesListDiv.innerHTML = '';
            exercicesListDiv.appendChild(createExerciceElement()); // Add one empty exercise back

            showMessage("Plan enregistré !", 2000);
            loadSavedPlans();
        }

        function loadSavedPlans() {
            const plans = getStoredData(PLANS_STORAGE_KEY);
            savedPlansListDiv.innerHTML = '';

            if (plans.length === 0) {
                savedPlansListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun plan sauvegardé.</p>';
                return;
            }

            plans.sort((a, b) => new Date(b.date) - new Date(a.date));

            plans.forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = 'p-3 bg-white rounded-md border border-brand-gray-border flex justify-between items-start gap-2'; // Added gap
                planDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium text-sm">${formatDate(plan.date)}</p>
                        ${plan.goal ? `<p class="text-xs text-gray-600 mt-1">Objectif: ${plan.goal}</p>` : ''}
                        <ul class="text-xs text-gray-600 mt-1 list-disc list-inside">
                            ${plan.exercises.map(ex => `<li>${ex.text}${ex.duration ? ` (${ex.duration} min)` : ''}</li>`).join('')}
                        </ul>
                    </div>
                    <button type="button" data-id="${plan.id}" class="remove-plan-btn btn btn-danger-outline !p-1 !text-xs flex-shrink-0" title="Supprimer ce plan">
                        Supprimer
                    </button>
                `;
                // Add event listener for deletion
                planDiv.querySelector('.remove-plan-btn').addEventListener('click', removePlan);
                savedPlansListDiv.appendChild(planDiv);
            });
        }

        function removePlan(event) {
            const planIdToRemove = parseInt(event.currentTarget.dataset.id, 10);
            let plans = getStoredData(PLANS_STORAGE_KEY);
            plans = plans.filter(plan => plan.id !== planIdToRemove);
            saveStoredData(PLANS_STORAGE_KEY, plans);
            loadSavedPlans();
            showMessage("Plan supprimé.", 2000);
        }

        savePlanBtn.addEventListener('click', savePlan);
        // Initialize with one empty exercise field
        if (exercicesListDiv.children.length === 0) {
             exercicesListDiv.appendChild(createExerciceElement());
        }


        // --- Bibliothèque Section (Répertoire) ---
        const addPieceBtn = document.getElementById('add-piece-btn');
        const pieceTitleInput = document.getElementById('piece-title');
        const pieceComposerInput = document.getElementById('piece-composer');
        const pieceCategorySelect = document.getElementById('piece-category');
        const piecesListDiv = document.getElementById('pieces-list');

        function populateCategoryDropdown() {
            // Only populate if empty to avoid duplicates on section switch
            if (pieceCategorySelect.options.length <= 1) {
                pieceCategorySelect.innerHTML = '<option value="" disabled selected>Choisir un genre...</option>'; // Placeholder
                PIECE_CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    pieceCategorySelect.appendChild(option);
                });
                 // Add an option for "Autre" if not in the list, or ensure it's selectable
                if (!PIECE_CATEGORIES.includes("Autre")) {
                     const autreOption = document.createElement('option');
                     autreOption.value = "Autre";
                     autreOption.textContent = "Autre";
                     pieceCategorySelect.appendChild(autreOption);
                }
                 pieceCategorySelect.value = ""; // Ensure placeholder is selected initially
            }
        }


        function loadPieces() {
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            piecesListDiv.innerHTML = '';

            if (pieces.length === 0) {
                piecesListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune pièce enregistrée.</p>';
                return;
            }

             const groupedPieces = pieces.reduce((acc, piece) => {
                 const category = piece.category || "Autre";
                 (acc[category] = acc[category] || []).push(piece);
                 return acc;
             }, {});

             const sortedCategories = Object.keys(groupedPieces).sort((a, b) => {
                 if (a === "Autre") return 1; if (b === "Autre") return -1;
                 return a.localeCompare(b);
             });

             sortedCategories.forEach(category => {
                 const categoryDiv = document.createElement('div');
                 categoryDiv.className = 'mb-4';
                 const categoryTitle = document.createElement('h4');
                 categoryTitle.className = 'font-medium text-sm uppercase tracking-wider text-gray-500 mb-2 border-b border-brand-gray-border pb-1';
                 categoryTitle.textContent = category;
                 categoryDiv.appendChild(categoryTitle);

                 const categoryList = document.createElement('div'); // Container for pieces in this category
                 categoryList.className = 'space-y-3'; // Add spacing between pieces

                 groupedPieces[category].sort((a, b) => {
                     const composerCompare = (a.composer || '').localeCompare(b.composer || '');
                     return composerCompare !== 0 ? composerCompare : (a.title || '').localeCompare(b.title || '');
                 }).forEach(piece => {
                     const pieceDiv = document.createElement('div');
                     pieceDiv.className = 'p-3 bg-white rounded-md border border-brand-gray-border flex justify-between items-start gap-2'; // Added gap
                     pieceDiv.innerHTML = `
                         <div class="flex-grow">
                             <p class="font-medium text-sm">${piece.title || 'Titre inconnu'}</p>
                             <p class="text-xs text-gray-600 mt-1">${piece.composer || 'Compositeur inconnu'}</p>
                         </div>
                         <button type="button" data-id="${piece.id}" class="remove-piece-btn btn btn-danger-outline !p-1 !text-xs flex-shrink-0" title="Supprimer cette pièce">
                             Supprimer
                         </button>
                     `;
                     // Add event listener for deletion
                     pieceDiv.querySelector('.remove-piece-btn').addEventListener('click', removePiece);
                     categoryList.appendChild(pieceDiv);
                 });
                 categoryDiv.appendChild(categoryList); // Append the list of pieces to the category container
                 piecesListDiv.appendChild(categoryDiv); // Append the whole category container
             });
        }


        function addPiece() {
            const title = pieceTitleInput.value.trim();
            const composer = pieceComposerInput.value.trim();
            const category = pieceCategorySelect.value;

            if (!title) {
                showMessage("Veuillez entrer un titre.", 3000); return;
            }
            if (!category) {
                 showMessage("Veuillez choisir un genre.", 3000); return;
            }

            const pieces = getStoredData(PIECES_STORAGE_KEY);
            const newPiece = { id: Date.now(), title, composer, category };
            pieces.push(newPiece);
            saveStoredData(PIECES_STORAGE_KEY, pieces);

            pieceTitleInput.value = '';
            pieceComposerInput.value = '';
            pieceCategorySelect.value = ''; // Reset dropdown to placeholder
            loadPieces();
            showMessage("Pièce ajoutée !", 2000);
            populateJournalPieceDropdown();
        }

        function removePiece(event) {
            const pieceIdToRemove = parseInt(event.currentTarget.dataset.id, 10);
            let pieces = getStoredData(PIECES_STORAGE_KEY);
            pieces = pieces.filter(piece => piece.id !== pieceIdToRemove);
            saveStoredData(PIECES_STORAGE_KEY, pieces);
            loadPieces();
            showMessage("Pièce supprimée.", 2000);
            populateJournalPieceDropdown();
        }

        addPieceBtn.addEventListener('click', addPiece);

        // --- Journal Section ---
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const journalDateInput = document.getElementById('journal-date');
        const journalContentInput = document.getElementById('journal-content');
        const journalPieceSelect = document.getElementById('journal-piece');
        const journalEntriesDiv = document.getElementById('journal-entries');

        function populateJournalPieceDropdown() {
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            const currentValue = journalPieceSelect.value;
            // Store the current default option text
            const defaultOptionText = journalPieceSelect.options[0]?.textContent || '-- Sélectionner une pièce du répertoire --';
            journalPieceSelect.innerHTML = `<option value="">${defaultOptionText}</option>`; // Reset with default

             pieces.sort((a,b) => (a.title || '').localeCompare(b.title || '')).forEach(piece => {
                const option = document.createElement('option');
                option.value = piece.id;
                option.textContent = `${piece.title}${piece.composer ? ` (${piece.composer})` : ''}`;
                journalPieceSelect.appendChild(option);
            });
             // Restore previous selection if it exists
             if (currentValue && pieces.some(p => String(p.id) === currentValue)) {
                 journalPieceSelect.value = currentValue;
             } else {
                 journalPieceSelect.value = ""; // Ensure default is selected if previous selection is gone
             }
        }

        function loadJournalEntries() {
            const entries = getStoredData(JOURNAL_STORAGE_KEY);
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            journalEntriesDiv.innerHTML = '';

            if (entries.length === 0) {
                journalEntriesDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune entrée.</p>';
                return;
            }

            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'p-4 bg-white rounded-md border border-brand-gray-border relative';
                 const piece = entry.pieceId ? pieces.find(p => p.id === entry.pieceId) : null;

                entryDiv.innerHTML = `
                    <button type="button" data-id="${entry.id}" class="remove-journal-btn btn btn-danger-outline !p-1 !text-xs absolute top-2 right-2" title="Supprimer l'entrée">
                         Supprimer
                    </button>
                    <div class="flex justify-between items-center mb-2 pr-16"> <p class="font-medium text-sm">${formatDate(entry.date)}</p>
                        ${piece ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full flex-shrink-0">${piece.category || 'Autre'}</span>` : ''}
                    </div>
                    ${piece ? `
                        <div class="mb-2">
                            <p class="text-sm font-semibold">${piece.title || 'Titre inconnu'}</p>
                            <p class="text-xs text-gray-600">${piece.composer || 'Compositeur inconnu'}</p>
                        </div>
                    ` : ''}
                    <p class="text-sm whitespace-pre-wrap text-gray-800">${entry.content || 'Aucune note.'}</p>
                `;
                // Add event listener for deletion
                entryDiv.querySelector('.remove-journal-btn').addEventListener('click', removeJournalEntry);
                journalEntriesDiv.appendChild(entryDiv);
            });
        }


        function saveJournalEntry() {
            const date = journalDateInput.value;
            const content = journalContentInput.value.trim();
            const pieceId = journalPieceSelect.value ? parseInt(journalPieceSelect.value, 10) : null;

            if (!date) { showMessage("Veuillez sélectionner une date.", 3000); return; }
            if (!content) { showMessage("Veuillez ajouter des notes.", 3000); return; }

            const entries = getStoredData(JOURNAL_STORAGE_KEY);
            const newEntry = { id: Date.now(), date, content, pieceId };
            entries.push(newEntry);
            saveStoredData(JOURNAL_STORAGE_KEY, entries);

            journalContentInput.value = '';
            journalPieceSelect.value = ''; // Reset dropdown
            loadJournalEntries();
            showMessage("Entrée enregistrée !", 2000);
        }

         function removeJournalEntry(event) {
            const entryIdToRemove = parseInt(event.currentTarget.dataset.id, 10);
            let entries = getStoredData(JOURNAL_STORAGE_KEY);
            entries = entries.filter(entry => entry.id !== entryIdToRemove);
            saveStoredData(JOURNAL_STORAGE_KEY, entries);
            loadJournalEntries();
            showMessage("Entrée supprimée.", 2000);
        }

        saveJournalBtn.addEventListener('click', saveJournalEntry);


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date in date inputs
            try {
                const today = new Date().toISOString().split('T')[0];
                sessionDateInput.value = today;
                journalDateInput.value = today;
            } catch (e) {
                 console.error("Error setting today's date:", e);
                 // Handle cases where date input might not be supported or fails
            }


             // Populate static dropdowns
             populateCategoryDropdown();

             // Set default active section
             setActiveSection('planification'); // Start on Planification tab

             // Load initial data for the default section
             loadSavedPlans();


            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js', { scope: './' }) // Explicit scope
                    .then(registration => {
                        console.log('Service Worker: Registered scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker: Registration failed:', error);
                    });
            } else {
                 console.log('Service workers are not supported.');
            }
        });

    </script>
</body>
</html>
