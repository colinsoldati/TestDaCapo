<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DaCapo - Suivi de Pratique Musicale</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons';
        font-size: 1.25rem; /* Adjust size as needed */
        line-height: 1;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-transform: none;
        speak: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Tailwind configuration */
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['DM Sans', 'sans-serif'],
              montserrat: ['Montserrat', 'sans-serif'],
            },
            colors: {
              'brand-black': '#000000',
              'brand-white': '#FFFFFF',
              'brand-gray': '#F3F4F6', // Light gray for backgrounds
              'brand-gray-border': '#E5E7EB', // Lighter border color
            }
          }
        }
      }
      /* Basic body styling for fixed header/footer */
      body {
          display: flex;
          flex-direction: column;
          min-height: 100vh; /* Full viewport height */
          overscroll-behavior-y: contain; /* Prevent pull-to-refresh where possible */
      }
       main {
           flex-grow: 1; /* Takes remaining space */
           overflow-y: auto; /* Allows scrolling only for main content */
           /* Add padding to prevent content from hiding under fixed header/footer */
           /* Adjust padding values based on actual header/footer height */
           padding-top: 4.5rem; /* Approx height of header */
           padding-bottom: 4.5rem; /* Approx height of nav */
       }
       /* Style for active nav button */
       .nav-btn[aria-current="page"] {
           color: #000000; /* brand-black */
       }
       .nav-btn:not([aria-current="page"]) {
            color: #6B7280; /* gray-500 */
       }
       .nav-btn:not([aria-current="page"]):hover {
            color: #111827; /* gray-900 */
       }

    </style>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <link rel="icon" href="https://placehold.co/32x32/000000/FFFFFF?text=DC" type="image/png">


</head>
<body class="bg-brand-white text-brand-black font-sans">

    <header class="bg-brand-white border-b border-brand-gray-border p-4 fixed top-0 left-0 right-0 z-20 h-[4.5rem] flex items-center justify-center">
        <h1 class="text-2xl font-montserrat font-bold text-center">DaCapo</h1>
    </header>

    <main class="container mx-auto p-4 w-full">

        <section id="planification" class="space-y-4">
            <h2 class="text-xl font-montserrat font-semibold mb-3 border-b border-brand-gray-border pb-1">Planification de Session</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 space-y-3 shadow-sm">
                <h3 class="font-montserrat font-medium">Nouvelle Session</h3>
                <div>
                    <label for="session-date" class="block text-sm font-medium mb-1">Date :</label>
                    <input type="date" id="session-date" name="session-date" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                </div>
                 <div>
                    <label for="session-goal" class="block text-sm font-medium mb-1">Objectif Principal :</label>
                    <input type="text" id="session-goal" name="session-goal" placeholder="Ex: Travailler la vélocité sur l'étude X" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                </div>
                <div id="exercices-list" class="space-y-2">
                    <div class="flex items-center space-x-2">
                         <input type="text" placeholder="Exercice (gamme, étude, morceau...)" class="flex-grow p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                         <input type="number" placeholder="Durée (min)" min="1" class="w-24 p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                         <button class="remove-exercice-btn p-2 text-red-600 hover:text-red-800" title="Supprimer">
                             <span class="lucide">&#xe03f;</span> </button>
                    </div>
                </div>
                <button id="add-exercice-btn" class="w-full flex items-center justify-center p-2 border border-brand-black rounded-md hover:bg-gray-200 transition-colors duration-150 text-brand-black bg-brand-white">
                    <span class="lucide mr-2">&#xe03b;</span> Ajouter un exercice
                </button>
                 <button id="save-plan-btn" class="w-full flex items-center justify-center p-2 border border-transparent bg-brand-black text-brand-white rounded-md hover:bg-gray-800 transition-colors duration-150 mt-2">
                    <span class="lucide mr-2">&#xe01a;</span> Sauvegarder le Plan (Bientôt)
                </button>
            </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 shadow-sm">
                <h3 class="font-montserrat font-medium mb-2">Plans Sauvegardés</h3>
                <p class="text-sm text-gray-500 italic">Fonctionnalité à venir...</p>
                </div>
        </section>

        <section id="journal" class="hidden space-y-4">
            <h2 class="text-xl font-montserrat font-semibold mb-3 border-b border-brand-gray-border pb-1">Journal de Bord</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 space-y-3 shadow-sm">
                 <h3 class="font-montserrat font-medium">Nouvelle Entrée</h3>
                 <div>
                     <label for="journal-date" class="block text-sm font-medium mb-1">Date :</label>
                     <input type="date" id="journal-date" name="journal-date" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                 </div>
                  <div>
                     <label for="journal-piece" class="block text-sm font-medium mb-1">Pièce Travaillée :</label>
                     <select id="journal-piece" name="journal-piece" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black appearance-none">
                         <option value="">-- Sélectionner une pièce --</option>
                         </select>
                 </div>
                 <div>
                     <label for="journal-content" class="block text-sm font-medium mb-1">Notes de pratique :</label>
                     <textarea id="journal-content" name="journal-content" rows="5" placeholder="Difficultés rencontrées, solutions trouvées, sensations, objectifs atteints..." class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black"></textarea>
                 </div>
                 <button id="save-journal-btn" class="w-full flex items-center justify-center p-2 border border-transparent bg-brand-black text-brand-white rounded-md hover:bg-gray-800 transition-colors duration-150">
                     <span class="lucide mr-2">&#xe01a;</span> Enregistrer l'entrée
                 </button>
             </div>

             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 shadow-sm">
                <h3 class="font-montserrat font-medium mb-2">Entrées Précédentes</h3>
                <div id="journal-entries" class="space-y-4">
                    <p class="text-sm text-gray-500 italic">Aucune entrée pour le moment.</p>
                </div>
            </div>
        </section>

        <section id="progres" class="hidden space-y-4">
            <h2 class="text-xl font-montserrat font-semibold mb-3 border-b border-brand-gray-border pb-1">Analyse des Progrès</h2>
             <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 shadow-sm">
                <h3 class="font-montserrat font-medium mb-2">Statistiques (Exemple)</h3>
                <p>Nombre d'entrées dans le journal : <span id="journal-entry-count">0</span></p>
                <p class="text-sm text-gray-500 italic mt-4">Des graphiques et analyses plus détaillés seront ajoutés ici.</p>
                <div id="charts-container" class="mt-4">
                     </div>
            </div>
        </section>

        <section id="bibliotheque" class="hidden space-y-4">
            <h2 class="text-xl font-montserrat font-semibold mb-3 border-b border-brand-gray-border pb-1">Mon Répertoire</h2>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 space-y-3 shadow-sm">
                 <h3 class="font-montserrat font-medium">Ajouter une Pièce</h3>
                 <div>
                     <label for="piece-name" class="block text-sm font-medium mb-1">Nom de la pièce :</label>
                     <input type="text" id="piece-name" name="piece-name" placeholder="Ex: Sonate K.545, 1er Mvt" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                 </div>
                  <div>
                     <label for="piece-category" class="block text-sm font-medium mb-1">Catégorie :</label>
                     <select id="piece-category" name="piece-category" class="w-full p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black appearance-none">
                         </select>
                 </div>
                 <button id="add-piece-btn" class="w-full flex items-center justify-center p-2 border border-transparent bg-brand-black text-brand-white rounded-md hover:bg-gray-800 transition-colors duration-150">
                     <span class="lucide mr-2">&#xe03b;</span> Ajouter la pièce
                 </button>
            </div>

            <div class="bg-brand-gray border border-brand-gray-border rounded-lg p-4 shadow-sm">
                <h3 class="font-montserrat font-medium mb-2">Pièces Enregistrées</h3>
                <div id="pieces-list" class="space-y-3">
                    <p class="text-sm text-gray-500 italic">Aucune pièce enregistrée pour le moment.</p>
                </div>
            </div>
        </section>

         <div id="message-box" class="fixed bottom-[5.5rem] right-4 bg-brand-black text-brand-white p-3 rounded-lg shadow-md hidden transition-opacity duration-300 z-50 max-w-xs">
            <span id="message-text"></span>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="ml-4 font-bold absolute top-1 right-2 text-sm">X</button>
        </div>

    </main>

    <nav class="bg-brand-white border-t border-brand-gray-border p-2 fixed bottom-0 left-0 right-0 z-20 h-[4.5rem] flex items-center">
        <ul class="flex justify-around w-full">
            <li>
                <button data-target="planification" class="nav-btn flex flex-col items-center p-2 rounded-md" aria-current="page">
                    <span class="lucide">&#xe4bc;</span> <span class="text-xs font-medium mt-1">Plan</span>
                </button>
            </li>
            <li>
                <button data-target="journal" class="nav-btn flex flex-col items-center p-2 rounded-md">
                    <span class="lucide">&#xe9d3;</span> <span class="text-xs font-medium mt-1">Journal</span>
                </button>
            </li>
            <li>
                <button data-target="progres" class="nav-btn flex flex-col items-center p-2 rounded-md">
                    <span class="lucide">&#xe151;</span> <span class="text-xs font-medium mt-1">Progrès</span>
                </button>
            </li>
            <li>
                <button data-target="bibliotheque" class="nav-btn flex flex-col items-center p-2 rounded-md">
                   <span class="lucide">&#xe938;</span> <span class="text-xs font-medium mt-1">Répertoire</span>
                </button>
            </li>
        </ul>
    </nav>

    <script>
        // --- Constants ---
        const PIECES_STORAGE_KEY = 'dacapoPieces';
        const JOURNAL_STORAGE_KEY = 'dacapoJournalEntries';
        const PIECE_CATEGORIES = ["Sonate", "Concerto", "Caprice/Etude", "Prélude", "Fugue", "Nocturne", "Valse", "Impromptu", "Autre"];

        // --- Utility Functions ---
        function showMessage(text, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            if (!messageBox || !messageText) return;

            messageText.textContent = text;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function getStoredData(key) {
            return JSON.parse(localStorage.getItem(key) || '[]');
        }

        function saveStoredData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function formatDate(dateString) {
             if (!dateString) return 'Date inconnue';
             // Ensure dateString is treated as local time, not UTC
             const [year, month, day] = dateString.split('-');
             const date = new Date(year, month - 1, day); // Month is 0-indexed
             return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
        }


        // --- Navigation ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('main section');

        function setActiveSection(targetId) {
             // Hide all sections
            sections.forEach(section => section.classList.add('hidden'));
            // Show target section
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
             // Update button styles
            navButtons.forEach(btn => {
                if (btn.dataset.target === targetId) {
                    btn.setAttribute('aria-current', 'page');
                } else {
                    btn.removeAttribute('aria-current');
                }
            });

             // Load data specific to the section if needed
             if (targetId === 'journal') {
                 populateJournalPieceDropdown();
                 loadJournalEntries(); // Reload entries to ensure piece names are fresh
             }
             if (targetId === 'bibliotheque') {
                 loadPieces();
             }
             if (targetId === 'progres') {
                 updateProgressStats();
             }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveSection(button.dataset.target);
            });
        });

        // --- Planification Section ---
        const addExerciceBtn = document.getElementById('add-exercice-btn');
        const exercicesList = document.getElementById('exercices-list');
        const savePlanBtn = document.getElementById('save-plan-btn'); // Placeholder button

        addExerciceBtn.addEventListener('click', () => {
            const exerciceDiv = document.createElement('div');
            exerciceDiv.className = 'flex items-center space-x-2';
            exerciceDiv.innerHTML = `
                <input type="text" placeholder="Exercice (gamme, étude, morceau...)" class="flex-grow p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                <input type="number" placeholder="Durée (min)" min="1" class="w-24 p-2 border border-brand-gray-border rounded-md bg-brand-white focus:outline-none focus:ring-1 focus:ring-brand-black">
                <button class="remove-exercice-btn p-2 text-red-600 hover:text-red-800" title="Supprimer">
                    <span class="lucide">&#xe03f;</span> </button>
            `;
            exercicesList.appendChild(exerciceDiv);
            // Add event listener to the new remove button
            exerciceDiv.querySelector('.remove-exercice-btn').addEventListener('click', (e) => {
                 e.currentTarget.closest('.flex').remove();
            });
        });

        // Add event listener to initially present remove buttons
        exercicesList.querySelectorAll('.remove-exercice-btn').forEach(button => {
             button.addEventListener('click', (e) => {
                 e.currentTarget.closest('.flex').remove();
             });
        });

        savePlanBtn.addEventListener('click', () => {
            showMessage("La sauvegarde des plans sera bientôt disponible !", 3000);
        });


        // --- Bibliothèque Section (Répertoire) ---
        const addPieceBtn = document.getElementById('add-piece-btn');
        const pieceNameInput = document.getElementById('piece-name');
        const pieceCategorySelect = document.getElementById('piece-category');
        const piecesListDiv = document.getElementById('pieces-list');

        function populateCategoryDropdown() {
            pieceCategorySelect.innerHTML = ''; // Clear existing options
            PIECE_CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                pieceCategorySelect.appendChild(option);
            });
        }

        function loadPieces() {
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            piecesListDiv.innerHTML = ''; // Clear existing list

            if (pieces.length === 0) {
                piecesListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune pièce enregistrée pour le moment.</p>';
                return;
            }

             // Optional: Group by category for display
             const groupedPieces = pieces.reduce((acc, piece) => {
                 (acc[piece.category] = acc[piece.category] || []).push(piece);
                 return acc;
             }, {});

             // Sort categories alphabetically, except "Autre" at the end
             const sortedCategories = Object.keys(groupedPieces).sort((a, b) => {
                 if (a === "Autre") return 1;
                 if (b === "Autre") return -1;
                 return a.localeCompare(b);
             });


             sortedCategories.forEach(category => {
                 const categoryDiv = document.createElement('div');
                 categoryDiv.className = 'mb-3';
                 const categoryTitle = document.createElement('h4');
                 categoryTitle.className = 'font-medium text-sm uppercase tracking-wider text-gray-600 mb-1';
                 categoryTitle.textContent = category;
                 categoryDiv.appendChild(categoryTitle);

                 groupedPieces[category].sort((a,b) => a.name.localeCompare(b.name)).forEach(piece => {
                     const pieceDiv = document.createElement('div');
                     pieceDiv.className = 'border-b border-brand-gray-border pb-2 flex justify-between items-center';
                     pieceDiv.innerHTML = `
                         <span class="text-sm">${piece.name}</span>
                         <button data-id="${piece.id}" class="remove-piece-btn p-1 text-red-600 hover:text-red-800" title="Supprimer">
                             <span class="lucide text-sm">&#xe03f;</span> </button>
                     `;
                     categoryDiv.appendChild(pieceDiv);
                 });
                 piecesListDiv.appendChild(categoryDiv);
             });


            // Add event listeners to remove buttons
            piecesListDiv.querySelectorAll('.remove-piece-btn').forEach(button => {
                button.addEventListener('click', removePiece);
            });
        }

        function addPiece() {
            const name = pieceNameInput.value.trim();
            const category = pieceCategorySelect.value;

            if (!name) {
                showMessage("Veuillez entrer un nom pour la pièce.", 3000);
                return;
            }

            const pieces = getStoredData(PIECES_STORAGE_KEY);
            const newPiece = {
                id: Date.now(), // Simple unique ID using timestamp
                name: name,
                category: category
            };
            pieces.push(newPiece);
            saveStoredData(PIECES_STORAGE_KEY, pieces);

            // Clear form and reload list
            pieceNameInput.value = '';
            // pieceCategorySelect.value = PIECE_CATEGORIES[0]; // Reset dropdown if needed
            loadPieces();
            showMessage("Pièce ajoutée au répertoire !", 2000);
             // Update journal dropdown in case user navigates there next
             populateJournalPieceDropdown();
        }

        function removePiece(event) {
            const pieceIdToRemove = parseInt(event.currentTarget.dataset.id, 10);
            let pieces = getStoredData(PIECES_STORAGE_KEY);
            pieces = pieces.filter(piece => piece.id !== pieceIdToRemove);
            saveStoredData(PIECES_STORAGE_KEY, pieces);
            loadPieces(); // Reload the list
            showMessage("Pièce supprimée.", 2000);
             // Update journal dropdown as the piece is no longer available
             populateJournalPieceDropdown();
        }

        addPieceBtn.addEventListener('click', addPiece);


        // --- Journal Section ---
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const journalDateInput = document.getElementById('journal-date');
        const journalContentInput = document.getElementById('journal-content');
        const journalPieceSelect = document.getElementById('journal-piece');
        const journalEntriesDiv = document.getElementById('journal-entries');

        function populateJournalPieceDropdown() {
            const pieces = getStoredData(PIECES_STORAGE_KEY);
            const currentValue = journalPieceSelect.value; // Preserve selection if possible
            journalPieceSelect.innerHTML = '<option value="">-- Sélectionner une pièce (Optionnel) --</option>'; // Clear existing options

             pieces.sort((a,b) => a.name.localeCompare(b.name)).forEach(piece => {
                const option = document.createElement('option');
                option.value = piece.id; // Store piece ID as value
                option.textContent = piece.name;
                journalPieceSelect.appendChild(option);
            });
             // Restore previous selection if the piece still exists
             if (pieces.some(p => p.id == currentValue)) {
                journalPieceSelect.value = currentValue;
             }
        }

        function loadJournalEntries() {
            const entries = getStoredData(JOURNAL_STORAGE_KEY);
            const pieces = getStoredData(PIECES_STORAGE_KEY); // Get pieces for name lookup
            journalEntriesDiv.innerHTML = ''; // Clear existing entries

            if (entries.length === 0) {
                journalEntriesDiv.innerHTML = '<p class="text-sm text-gray-500 italic">Aucune entrée pour le moment.</p>';
                return;
            }

            // Sort entries by date, newest first
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'border-b border-brand-gray-border pb-3';
                 // Find the piece name using the stored pieceId
                 const piece = pieces.find(p => p.id === entry.pieceId);
                 const pieceName = piece ? piece.name : 'Pièce non spécifiée'; // Handle case where piece was deleted or not set

                entryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-medium">${formatDate(entry.date)}</p>
                        ${piece ? `<span class="text-xs bg-brand-black text-brand-white px-1.5 py-0.5 rounded">${piece.category}</span>` : ''}
                    </div>
                    ${entry.pieceId ? `<p class="text-sm font-semibold mb-1">${pieceName}</p>` : ''}
                    <p class="text-sm whitespace-pre-wrap">${entry.content}</p>
                     <button data-id="${entry.id}" class="remove-journal-btn mt-2 p-1 text-red-600 hover:text-red-800 text-xs flex items-center" title="Supprimer l'entrée">
                         <span class="lucide text-xs mr-1">&#xe03f;</span> Supprimer
                     </button>
                `;
                journalEntriesDiv.appendChild(entryDiv);
            });

            // Add event listeners for delete buttons
             journalEntriesDiv.querySelectorAll('.remove-journal-btn').forEach(button => {
                button.addEventListener('click', removeJournalEntry);
            });
        }

        function saveJournalEntry() {
            const date = journalDateInput.value;
            const content = journalContentInput.value.trim();
            const pieceId = journalPieceSelect.value ? parseInt(journalPieceSelect.value, 10) : null; // Get selected piece ID, or null

            if (!date || !content) {
                showMessage("Veuillez remplir la date et les notes de pratique.", 3000);
                return;
            }

            const entries = getStoredData(JOURNAL_STORAGE_KEY);
            const newEntry = {
                id: Date.now(), // Unique ID for the entry
                date: date,
                content: content,
                pieceId: pieceId // Store the selected piece ID
            };
            entries.push(newEntry);
            saveStoredData(JOURNAL_STORAGE_KEY, entries);

            // Clear form and reload entries
            // journalDateInput.value = ''; // Keep date potentially
            journalContentInput.value = '';
            journalPieceSelect.value = ''; // Reset dropdown
            loadJournalEntries();
            showMessage("Entrée enregistrée !", 2000);
             updateProgressStats(); // Update stats after adding entry
        }

         function removeJournalEntry(event) {
            const entryIdToRemove = parseInt(event.currentTarget.dataset.id, 10);
            let entries = getStoredData(JOURNAL_STORAGE_KEY);
            entries = entries.filter(entry => entry.id !== entryIdToRemove);
            saveStoredData(JOURNAL_STORAGE_KEY, entries);
            loadJournalEntries(); // Reload the list
            showMessage("Entrée supprimée.", 2000);
             updateProgressStats(); // Update stats after removing entry
        }

        saveJournalBtn.addEventListener('click', saveJournalEntry);

        // --- Progrès Section ---
        const journalEntryCountSpan = document.getElementById('journal-entry-count');

        function updateProgressStats() {
             const entries = getStoredData(JOURNAL_STORAGE_KEY);
             if (journalEntryCountSpan) {
                journalEntryCountSpan.textContent = entries.length;
             }
             // Add more complex calculations or chart updates here later
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date in date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('session-date').value = today;
            document.getElementById('journal-date').value = today;

             // Populate static dropdowns
             populateCategoryDropdown();

             // Set default active section
             setActiveSection('planification'); // Start on Planification tab

             // Load data relevant to the initial section
             // (loadPieces and loadJournalEntries will be called when switching sections)
             updateProgressStats(); // Calculate initial stats


            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered avec succès:', registration);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement du Service Worker:', error);
                    });
            } else {
                 console.log('Service workers ne sont pas supportés par ce navigateur.');
            }
        });

    </script>
</body>
</html>
